{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Ansible 任务管理</title>
    <link href="{% static 'layui.css' %}" rel="stylesheet">
    <script src="{% static 'layui.js' %}"></script>
    <script src="{% static 'jquery-3.6.0.min.js' %}"></script>
    {#    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>#}

</head>
<body>

<div class="layui-container layui-row" style="padding: 20px;">

    <!-- 步骤1 -->
    <div id="step1" class="step-content active layui-panel ">
        <form class="layui-form layui-form-pane">

            <div class="layui-form-item">
                {#                <label class="layui-form-label">主机选择</label>#}
                <input type="hidden" name="host" id="hostInput">
                <table id="hostTable" lay-filter="hostTable"></table>
            </div>
            {#            <div class="layui-col-md4 layui-col-md-offset4">#}
            {#                <div class="grid-demo">偏移4列</div>#}
            {#            </div>#}

                <div class="layui-form-item  layui-col-md-offset10 ">
                    <button type="button"  class="layui-btn" onclick="nextStep()">下一步
                    </button>
                </div>



        </form>
    </div>
    {#    <div class="layui-panel">#}
    {# #}
    {#    </div>#}
    <!-- 步骤2 -->
    <div id="step2" class=" layui-panel step-content" style="display: none;">
        <form class="layui-form layui-form-pane" action="">
            <div class="layui-form-item">
                <label class="layui-form-label">任务名称</label>
                <div class="layui-input-block">
                    <input type="text" name="taskName" autocomplete="off" placeholder="请输入" lay-verify="required"
                           class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">详细等级</label>
                    <div class="layui-input-inline">
                        <input type="text" name="detail_level" autocomplete="off" placeholder="不输入默认为0"
                               class="layui-input">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">并发数</label>
                <div class="layui-input-inline">
                    <input type="number" name="forks" placeholder="不输入默认为5" lay-verify="required"
                           autocomplete="off"
                           class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">任务类型</label>
                <div class="layui-input-inline">
                    <select name="taskType" lay-filter="aihao">
                        <option value=""></option>
                        <option value="playbook">playbook</option>
                        <option value="ad-hoc">ad-hoc</option>
                    </select>
                </div>
            </div>

            <!-- 条件展示区 -->
            <div id="playbookArea" class="layui-form-item" style="display: none;">
                <label class="layui-form-label">Playbook脚本</label>
                <div class="layui-input-block">
                    <select name="playbook">
                        <option value="">请选择 Playbook</option>
                        <option value="setup">setup.yml</option>
                        <option value="deploy">deploy.yml</option>
                        <option value="backup">backup.yml</option>
                    </select>
                </div>
            </div>

            <div id="adhocArea" class="layui-form-item" style="display: none;">
                <div class="layui-form-item">
                    <label class="layui-form-label">模块名</label>
                    <div class="layui-input-block">
                        <input type="text" name="module" placeholder="例如：ping, shell, copy 等" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">参数</label>
                    <div class="layui-input-block">
                        <input type="text" name="arguments" placeholder="例如：chdir=/tmp echo 'hello'"
                               class="layui-input">
                    </div>
                </div>
            </div>

            <div class="layui-form-item layui-col-md-offset9">

                <button type="button" class="layui-btn" onclick="prevStep()">上一步</button>
                <button type="button" class="layui-btn" onclick="nextStep()">下一步</button>
            </div>
        </form>
    </div>
    <div id="step3" class=" layui-panel step-content" style="display: none;">
        <form class="layui-form layui-form-pane">

            <div class="layui-form-item">
                <p>请确认以下信息是否正确：</p>
                <p><strong>主机：</strong><span id="confirmHost"></span></p>
                <p><strong>任务名称：</strong><span id="confirmTaskName"></span></p>
                <p><strong>任务类型：</strong><span id="confirmTaskType"></span></p>

                <p id="confirmPlaybook" style="display: none;">Playbook 脚本：<span></span></p>
                <p id="confirmAdHocModule" style="display: none;">模块名：<span></span></p>
                <p id="confirmAdHocArgs" style="display: none;">参数：<span></span></p>
            </div>

            <div class="layui-form-item layui-col-md-offset9">
                <button type="button" class="layui-btn" onclick="prevStep()">上一步</button>
                <button type="button" class="layui-btn" onclick="submitFinalData()">提交任务</button>

            </div>

        </form>
    </div>

</div>


<script>
    let currentStep = 1;

    function showStep(step) {
        document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
        document.getElementById('step' + step).style.display = 'block';
    }

    window.nextStep = function () {
        if (currentStep < 4) {
            if (currentStep === 1) {
                const hostInput = document.getElementById('hostInput');
                const hostValue = hostInput ? hostInput.value : '未选择';
                document.getElementById('confirmHost').innerText = hostValue;

            } else if (currentStep === 2) {

                // ✅ 正确获取任务名称
                const taskNameInput = document.querySelector("input[name='taskName']");
                const taskName = taskNameInput ? taskNameInput.value : '未填写';

                // ✅ 正确获取任务类型下拉框
                const taskTypeSelect = document.querySelector("select[name='taskType']");
                let taskTypeValue = '';
                let taskTypeText = '未选择';

                if (taskTypeSelect) {
                    taskTypeValue = taskTypeSelect.value;
                    const selectedOption = taskTypeSelect.options[taskTypeSelect.selectedIndex];
                    taskTypeText = selectedOption ? selectedOption.text : '未选择';
                }

                // 设置页面显示
                document.getElementById('confirmTaskName').innerText = taskName;
                document.getElementById('confirmTaskType').innerText = taskTypeText;

                // 根据任务类型展示不同内容
                if (taskTypeValue === 'playbook') {
                    const playbookSelect = document.querySelector("select[name='playbook']");
                    let playbookText = '未选择';
                    if (playbookSelect && playbookSelect.options[playbookSelect.selectedIndex]) {
                        playbookText = playbookSelect.options[playbookSelect.selectedIndex].text;
                    }
                    document.querySelector("#confirmPlaybook span").innerText = playbookText;
                    document.getElementById('confirmPlaybook').style.display = 'block';
                    document.getElementById('confirmAdHocModule').style.display = 'none';
                    document.getElementById('confirmAdHocArgs').style.display = 'none';

                } else if (taskTypeValue === 'ad-hoc') {
                    const moduleInput = document.querySelector("input[name='module']");
                    const argsInput = document.querySelector("input[name='arguments']");

                    const module = moduleInput ? moduleInput.value : '未填写';
                    const argumentsVal = argsInput ? argsInput.value : '未填写';

                    document.querySelector("#confirmAdHocModule span").innerText = module;
                    document.querySelector("#confirmAdHocArgs span").innerText = argumentsVal;
                    document.getElementById('confirmAdHocModule').style.display = 'block';
                    document.getElementById('confirmAdHocArgs').style.display = 'block';
                    document.getElementById('confirmPlaybook').style.display = 'none';
                }
            }
            currentStep++;
            showStep(currentStep);
        }
    };

    window.prevStep = function () {
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    };


    layui.use('table', function () {
        var table = layui.table;
        var form = layui.form;

        // 监听任务类型下拉框变化
        form.on('select(aihao)', function (obj) {
            const selected = obj.value; // 获取选中的值

            if (selected === 'playbook') { // playbook
                $('#playbookArea').show();
                $('#adhocArea').hide();
            } else if (selected === 'ad-hoc') { // ad-hoc
                $('#playbookArea').hide();
                $('#adhocArea').show();
            } else {
                $('#playbookArea').hide();
                $('#adhocArea').hide();
            }
        });
        // 已知数据渲染
        table.render({
            elem: '#hostTable',
            url: '{% url 'host_manager:get_host_list_api' %}',
            page: true, // 是否显示分页
            limits: [5, 10, 50, 100, 200],
            limit: 5,// 每页默认显示的数量
            cols: [[ //标题栏
                {type: 'checkbox', fixed: 'left'},
                {
                    field: 'hostname',
                    title: '主机名'
                },
                {
                    field: 'ip',
                    title: 'IP地址',
                    sort: true
                },
                {
                    field: 'port',
                    title: '端口'
                },
                {
                    field: 'username',
                    title: '用户名'
                },
            ]],

        });
        // 触发表格复选框选择
        table.on('checkbox(hostTable)', function (obj) {

            const checkStatus = table.checkStatus('hostTable'); // 获取当前表格选中项
            const selectedHosts = checkStatus.data.map(item => item.id); // ✅ 改成 item.id
            const hostListStr = selectedHosts.join(',');

            $('#hostInput').val(hostListStr); // 显示为逗号分隔的字符串，用于页面展示
            $('#hostInput').data('hostIds', selectedHosts); // ✅ 可以用 data 存储真实 ID 数组


        });
    });


    function submitFinalData() {
        const formData = {};

        // Step 1: 主机信息
        const hostIds = $('#hostInput').data('hostIds') || [];
        if (hostIds.length > 0) {
            formData.inventory = hostIds; // ✅ 真正要提交的字段是 ID 列表
        } else {
            formData.inventory = [];
        }

        // Step 2: 表单数据
        const taskName = document.querySelector("input[name='taskName']");
        const detailLevel = document.querySelector("input[name='detail_level']");
        const forks = document.querySelector("input[name='forks']");
        const job_type = document.querySelector("select[name='taskType']");
        const playbook = document.querySelector("select[name='playbook']");
        const module_name = document.querySelector("input[name='module']");
        const module_args = document.querySelector("input[name='arguments']");

        // 基础字段
        formData.name = taskName ? taskName.value : '';
        formData.verbosity = detailLevel ? detailLevel.value : '0';
        formData.forks = forks ? forks.value : '5';
        formData.job_type = job_type ? job_type.value : '';

        // 根据任务类型添加不同字段
        if (job_type && job_type.value === 'playbook') {
            formData.playbook = playbook && playbook.value ? playbook.value : '';
        } else if (job_type && job_type.value === 'ad-hoc') {
            formData.module_name = module_name ? module_name.value : '';
            formData.module_args = module_args ? module_args.value : '';
        }
        console.log(formData)
        // 发送到后端
        $.ajax({
            url: '{% url "runner_jobs:job-create" %}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content') // 如果你用了 CSRF token
            },
            success: function (response) {
                {#alert('任务创建成功！');#}
                console.log('✅ 服务器返回：', response);

                var index = parent.layer.getFrameIndex(window.name); // 先得到当前 iframe 层的索引
                parent.layer.close(index); // 再执行关闭
            },
            error: function (xhr) {
                try {
                    const err = JSON.parse(xhr.responseText);
                    alert('创建失败：' + (err.message || '未知错误'));
                } catch (e) {
                    alert('创建失败：' + xhr.responseText);
                }
            }
        });
    }


    // jQuery 扩展：将表单转换成对象
    $.fn.serializeObject = function () {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function () {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };
</script>
</body>
</html>
